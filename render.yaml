services:
  # Django API Service - Optimized for production
  - type: web
    name: legacyprime-api
    env: python
    plan: free
    # Optimized build and start commands
    buildCommand: |
      cd backend && 
      pip install -r requirements.txt &&
      python manage.py collectstatic --noinput
    startCommand: cd backend && gunicorn legacyprime.asgi:application -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --workers 2 --timeout 120
    preDeploy: |
      cd backend && 
      python manage.py migrate --noinput &&
      echo "âœ… Database migrations completed"
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0  # Use stable Python version
      - key: DJANGO_SETTINGS_MODULE
        value: legacyprime.settings
      - key: DJANGO_SECRET_KEY
        sync: false
      - key: DJANGO_DEBUG
        value: false
      - key: DJANGO_ALLOWED_HOSTS
        value: "legacyprime.onrender.com,localhost,127.0.0.1"
      - key: DATABASE_URL
        fromDatabase:
          name: legacyprime-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: legacyprime-redis
          type: redis
          property: connectionString
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_STORAGE_BUCKET_NAME
        value: "legacyprime-media"
      # Add production-specific JWT settings
      - key: JWT_ALGORITHM
        value: "HS256"
    healthCheckPath: /api/health/
    autoDeploy: true

  # Frontend Service - Optimized for React + TypeScript
  - type: static
    name: legacyprime-web
    env: static
    plan: free
    buildCommand: |
      bun install &&
      bun run build
    staticPublishPath: ./dist
    envVars:
      - key: NODE_VERSION
        value: 18.17.0  # Specific stable version
      - key: VITE_API_URL
        value: "https://legacyprime-api.onrender.com/api"
      # Add frontend environment variables for better error handling
      - key: VITE_APP_ENV
        value: production
      - key: VITE_APP_NAME
        value: "Legacy Prime"
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600
      - path: /assets/*
        name: Cache-Control
        value: public, max-age=31536000, immutable
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

  # Redis service - Production configuration
  - type: redis
    name: legacyprime-redis
    plan: free
    ipAllowList: []
    maxmemoryPolicy: allkeys-lru

databases:
  - name: legacyprime-db
    databaseName: legacyprime
    plan: free
    ipAllowList: []