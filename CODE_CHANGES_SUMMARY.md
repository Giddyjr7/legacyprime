# Code Changes Summary - Deposit Wallet Address System

## Backend Changes

### 1. Model (backend/wallet/models.py)
**Added at end of file:**
```python
class WalletAddress(models.Model):
    """
    Stores wallet addresses per deposit method (e.g., Bitcoin, USDT-TRC20)
    """
    method_name = models.CharField(max_length=100, unique=True)
    wallet_address = models.CharField(max_length=255)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = "Wallet Address"
        verbose_name_plural = "Wallet Addresses"

    def __str__(self):
        return f"{self.method_name} -> {self.wallet_address}"
```

### 2. Serializer (backend/wallet/serializers.py)

**Changed imports:**
```python
# OLD:
from .models import WithdrawalAccount, SystemSettings

# NEW:
from .models import WithdrawalAccount, SystemSettings, WalletAddress
```

**Added at end of file:**
```python
class WalletAddressSerializer(serializers.ModelSerializer):
    class Meta:
        model = WalletAddress
        fields = ('id', 'method_name', 'wallet_address', 'created_at', 'updated_at')
        read_only_fields = ('created_at', 'updated_at')
```

### 3. Admin (backend/wallet/admin.py)

**Added imports:**
```python
# At the end of the file:
from .models import WalletAddress

@admin.register(WalletAddress)
class WalletAddressAdmin(admin.ModelAdmin):
    list_display = ('method_name', 'wallet_address', 'updated_at')
    search_fields = ('method_name', 'wallet_address')
    readonly_fields = ('created_at', 'updated_at')
    fields = ('method_name', 'wallet_address', 'created_at', 'updated_at')
```

### 4. Views (backend/wallet/views.py)

**Changed imports:**
```python
# OLD:
from .serializers import WithdrawalAccountSerializer, SystemSettingsSerializer
from .models import WithdrawalAccount, SystemSettings

# NEW:
from .serializers import WithdrawalAccountSerializer, SystemSettingsSerializer, WalletAddressSerializer
from .models import WithdrawalAccount, SystemSettings, WalletAddress
```

**Added at end of file:**
```python
class WalletAddressView(APIView):
    """Endpoint to return wallet address for a specific deposit method.

    Query params: ?method=USDT-TRC20
    """
    permission_classes = (permissions.AllowAny,)

    def get(self, request):
        method = request.query_params.get('method')
        if not method:
            return Response({"error": "method query parameter is required"}, status=status.HTTP_400_BAD_REQUEST)

        # Try case-insensitive match
        try:
            wa = WalletAddress.objects.get(method_name__iexact=method)
        except WalletAddress.DoesNotExist:
            return Response({"error": "Wallet address not found for the provided method"}, status=status.HTTP_404_NOT_FOUND)

        serializer = WalletAddressSerializer(wa)
        return Response(serializer.data)
```

### 5. URLs (backend/wallet/urls.py)

**Changed imports:**
```python
# OLD:
from .views import (
    WithdrawalAccountListCreateView,
    WithdrawalAccountDetailView,
    DepositRequestView,
    ConfirmDepositView,
    WithdrawalRequestView,
    SystemSettingsView,
)

# NEW:
from .views import (
    WithdrawalAccountListCreateView,
    WithdrawalAccountDetailView,
    DepositRequestView,
    ConfirmDepositView,
    WithdrawalRequestView,
    SystemSettingsView,
    WalletAddressView,
)
```

**Added new route in urlpatterns:**
```python
# In urlpatterns, add after the withdraw line:
path('address/', WalletAddressView.as_view(), name='wallet_address'),
```

**Complete urlpatterns section:**
```python
urlpatterns = [
    path('withdrawal-accounts/', WithdrawalAccountListCreateView.as_view(), name='withdrawal_accounts'),
    path('withdrawal-accounts/<int:pk>/', WithdrawalAccountDetailView.as_view(), name='withdrawal_account_detail'),
    # Financial flow endpoints
    path('deposit/request/', DepositRequestView.as_view(), name='deposit_request'),
    path('deposit/<int:pk>/confirm/', ConfirmDepositView.as_view(), name='deposit_confirm'),
    path('withdraw/', WithdrawalRequestView.as_view(), name='withdraw_request'),
    # Wallet address lookup per deposit method
    path('address/', WalletAddressView.as_view(), name='wallet_address'),
    # System settings endpoint
    path('settings/', SystemSettingsView.as_view(), name='system_settings'),
]
```

### 6. Migration (NEW FILE: backend/wallet/migrations/0003_walletaddress.py)

```python
# Generated by manual edit to add WalletAddress model
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('wallet', '0002_systemsettings'),
    ]

    operations = [
        migrations.CreateModel(
            name='WalletAddress',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('method_name', models.CharField(max_length=100, unique=True)),
                ('wallet_address', models.CharField(max_length=255)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Wallet Address',
                'verbose_name_plural': 'Wallet Addresses',
            },
        ),
    ]
```

---

## Frontend Changes

### 1. API Endpoints (src/config/api.ts)

**Added new endpoint after WALLET_DEPOSIT_CONFIRM:**
```typescript
// In ENDPOINTS object, add:
WALLET_ADDRESS_BY_METHOD: (method: string) => joinUrl(API_BASE_URL, `wallet/address/?method=${encodeURIComponent(method)}`),
```

**Full Wallet section:**
```typescript
  // Wallet
  WALLET_DEPOSIT_REQUEST: joinUrl(API_BASE_URL, 'wallet/deposit/request/'),
  WALLET_DEPOSIT_CONFIRM: (id: number) => joinUrl(API_BASE_URL, `wallet/deposit/${id}/confirm/`),
  WALLET_ADDRESS_BY_METHOD: (method: string) => joinUrl(API_BASE_URL, `wallet/address/?method=${encodeURIComponent(method)}`),
  WALLET_WITHDRAW: joinUrl(API_BASE_URL, 'wallet/withdraw/'),
  WALLET_WITHDRAWAL_ACCOUNTS: joinUrl(API_BASE_URL, 'wallet/withdrawal-accounts/'),
  WALLET_SETTINGS: joinUrl(API_BASE_URL, 'wallet/settings/'),
```

### 2. ConfirmDeposit Component (src/pages/dashboard/ConfirmDeposit.tsx)

**REPLACED the useEffect hook:**

```typescript
// OLD:
useEffect(() => {
  const fetchWalletAddress = async () => {
    try {
      setIsFetching(true);
      const response = await api.get(ENDPOINTS.WALLET_SETTINGS);
      setWalletAddress(response.data.deposit_wallet_address);
    } catch (err) {
      console.error('Failed to fetch wallet address:', err);
      toast({
        title: 'Error',
        description: 'Failed to load wallet address. Please refresh the page.',
        variant: 'destructive',
      });
    } finally {
      setIsFetching(false);
    }
  };

  fetchWalletAddress();
}, [toast]);

// NEW:
useEffect(() => {
  const fetchWalletAddress = async () => {
    try {
      setIsFetching(true);
      const method = (location.state || {}).method || '';
      if (!method) {
        toast({
          title: 'Error',
          description: 'No payment method specified.',
          variant: 'destructive',
        });
        return;
      }
      // Fetch wallet address specific to the selected method
      const response = await api.get(ENDPOINTS.WALLET_ADDRESS_BY_METHOD(method));
      setWalletAddress(response.data.wallet_address);
    } catch (err) {
      console.error('Failed to fetch wallet address:', err);
      toast({
        title: 'Error',
        description: 'Failed to load wallet address. Please refresh the page.',
        variant: 'destructive',
      });
    } finally {
      setIsFetching(false);
    }
  };

  fetchWalletAddress();
}, [location.state, toast]);
```

**Key Changes:**
- Now extracts `method` from `location.state`
- Uses new `WALLET_ADDRESS_BY_METHOD` endpoint
- Passes the method as a query parameter
- Accesses `response.data.wallet_address` instead of `response.data.deposit_wallet_address`
- Added `location.state` to dependency array

---

## Database Changes

### New Table: wallet_walletaddress

**SQL Equivalent:**
```sql
CREATE TABLE wallet_walletaddress (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    method_name VARCHAR(100) UNIQUE NOT NULL,
    wallet_address VARCHAR(255) NOT NULL,
    created_at DATETIME(6) AUTO_NOW_ADD,
    updated_at DATETIME(6) AUTO_NOW
);
```

**Indexes:**
- Primary Key: id
- Unique: method_name

---

## Testing Checklist

### Backend Tests

```bash
# Test 1: Check migration
python manage.py showmigrations wallet
# Expected: wallet 0003_walletaddress should be listed

# Test 2: Apply migration
python manage.py migrate wallet
# Expected: "OK - wallet.0003_walletaddress"

# Test 3: Check model in shell
python manage.py shell
from wallet.models import WalletAddress
WalletAddress.objects.create(method_name='BITCOIN', wallet_address='1A1z7agoat3xFZ88MP357yvDNy3e7c3DZ9')
# Expected: <WalletAddress: BITCOIN -> 1A1z7agoat3xFZ88MP357yvDNy3e7c3DZ9>

# Test 4: API endpoint
curl "http://localhost:8000/api/wallet/address/?method=BITCOIN"
# Expected: 200 with wallet data
```

### Frontend Tests

```javascript
// Test 1: Check endpoint config
console.log(ENDPOINTS.WALLET_ADDRESS_BY_METHOD('BITCOIN'))
// Expected: "http://localhost:8000/api/wallet/address/?method=BITCOIN"

// Test 2: Navigate to Deposit
// - Select a method
// - Confirm
// Expected: Wallet address appears

// Test 3: Check network tab
// - Should see GET request to /api/wallet/address/?method=<method>
// - Response includes wallet_address field

// Test 4: Test error handling
// - Try with non-existent method
// Expected: Error message displayed
```

---

## Deployment Checklist

- [ ] All files backed up
- [ ] Review all code changes
- [ ] Test locally first
- [ ] Run: `python manage.py migrate wallet`
- [ ] Add wallet addresses via admin
- [ ] Test deposit flow on staging
- [ ] Verify API endpoint returns data
- [ ] Check frontend displays correct address
- [ ] Monitor logs for errors
- [ ] Test each payment method
- [ ] Verify existing deposits still work

---

## Rollback Plan (If Needed)

```bash
# Step 1: Reverse migration
python manage.py migrate wallet 0002_systemsettings

# Step 2: Revert code changes (use git)
git checkout HEAD -- backend/wallet/
git checkout HEAD -- src/

# Step 3: Restart servers
```

---

**Date:** November 22, 2025
**Status:** âœ… Ready for Deployment
